
#include "stddef.h"
#include "stdint.h"
#include "stdlib.h"
#include <string.h>
#include "lib/sound.h"
#include "lib/ticker.h"

#include "gpio_api.h"
#include "device.h"
#include "py/obj.h"
#include "py/objstr.h"
#include "py/runtime.h"


#define TheTimer NRF_TIMER1

extern void gpiote_init(PinName pin, uint8_t channel_number);


/** Initialize the Programmable Peripheral Interconnect peripheral.
 * Mostly copied from pwmout_api.c
 */
static void ppi_init(uint8_t channel0, uint8_t channel1) {
    NRF_TIMER_Type *timer  = TheTimer;

    /* Attach CLOCK[0] and CLOCK[1] to channel0
     * CLOCK[2] and CLOCK[3] to channel1 */
    NRF_PPI->CH[0].EEP = (uint32_t)&timer->EVENTS_COMPARE[0];
    NRF_PPI->CH[0].TEP = (uint32_t)&NRF_GPIOTE->TASKS_OUT[channel0];
    NRF_PPI->CH[1].EEP = (uint32_t)&timer->EVENTS_COMPARE[1];
    NRF_PPI->CH[1].TEP = (uint32_t)&NRF_GPIOTE->TASKS_OUT[channel0];
    NRF_PPI->CH[2].EEP = (uint32_t)&timer->EVENTS_COMPARE[2];
    NRF_PPI->CH[2].TEP = (uint32_t)&NRF_GPIOTE->TASKS_OUT[channel1];
    NRF_PPI->CH[3].EEP = (uint32_t)&timer->EVENTS_COMPARE[3];
    NRF_PPI->CH[3].TEP = (uint32_t)&NRF_GPIOTE->TASKS_OUT[channel1];

    // Enable PPI channels.
    NRF_PPI->CHEN |= 15;
}

static inline void timer_stop(void) {
    TheTimer->TASKS_STOP = 1;
}

static inline void timer_start(void) {
    TheTimer->TASKS_START = 1;
    __NOP();
    __NOP();
    __NOP();
}

static int16_t previous_value = 0;
static int16_t delta = 0;
static uint8_t running = 1;
static bool sample;

void sound_stop(void) {
    timer_stop();
    clear_ticker_callback(0);
    running = 0;
    previous_value = 0;
    delta = 0;
}

static int32_t sound_ticker(void);

void sound_start(void) {
    timer_start();
    running = 1;
    sample = false;
    set_ticker_callback(0, sound_ticker, 1);
}

static void pin_init(int pin) {
    NRF_GPIO->PIN_CNF[pin] = (GPIO_PIN_CNF_SENSE_Disabled << GPIO_PIN_CNF_SENSE_Pos)
                            | (GPIO_PIN_CNF_DRIVE_H0H1 << GPIO_PIN_CNF_DRIVE_Pos)
                            | (GPIO_PIN_CNF_PULL_Disabled << GPIO_PIN_CNF_PULL_Pos)
                            | (GPIO_PIN_CNF_INPUT_Connect << GPIO_PIN_CNF_INPUT_Pos)
                            | (GPIO_PIN_CNF_DIR_Output << GPIO_PIN_CNF_DIR_Pos);
    NRF_GPIO->OUTCLR = 1UL << pin;
}

static void connect_pin_to_channel(int pin, uint8_t channel) {
    /* Configure channel to Pin31, not connected to the pin, and configure as a tasks that will set it to proper level */
    NRF_GPIOTE->CONFIG[channel] = (GPIOTE_CONFIG_MODE_Task << GPIOTE_CONFIG_MODE_Pos) |
                                         (31UL << GPIOTE_CONFIG_PSEL_Pos) |
                                         (GPIOTE_CONFIG_POLARITY_HiToLo << GPIOTE_CONFIG_POLARITY_Pos);
    /* Three NOPs are required to make sure configuration is written before setting tasks or getting events */
    __NOP();
    __NOP();
    __NOP();
    /* Launch the task to take the GPIOTE channel output to the desired level */
    NRF_GPIOTE->TASKS_OUT[channel] = 1;

    /* Configure the channel */
    NRF_GPIOTE->CONFIG[channel] = (GPIOTE_CONFIG_MODE_Task << GPIOTE_CONFIG_MODE_Pos)
                                  | ((uint32_t)pin << GPIOTE_CONFIG_PSEL_Pos)
                                  | ((uint32_t)GPIOTE_CONFIG_POLARITY_Toggle << GPIOTE_CONFIG_POLARITY_Pos)
                                  | ((uint32_t)GPIOTE_CONFIG_OUTINIT_Low << GPIOTE_CONFIG_OUTINIT_Pos);
    __NOP();
    __NOP();
    __NOP();
}

extern void gpiote_init(PinName pin, uint8_t channel_number);

void sound_init(void) {
    //Allocate buffer
    sound_buffer_ptr = malloc(SOUND_BUFFER_SIZE);
    reset_buffer();
    /* TO DO: make it configurable which pins we use */
    int pin0 = P0_3;
    int pin1 = P0_2;
    TheTimer->POWER = 1;
    NRF_TIMER_Type *timer = TheTimer;
    sound_stop();
    timer->TASKS_CLEAR = 1;
    timer->MODE = TIMER_MODE_MODE_Timer;
    timer->BITMODE = TIMER_BITMODE_BITMODE_16Bit << TIMER_BITMODE_BITMODE_Pos;
    timer->PRESCALER = 0; //Full speed
    timer->SHORTS = 0;
    //pin_init(pin0);
    //pin_init(pin1);
    //connect_pin_to_channel(pin0, 0);
    //connect_pin_to_channel(pin1, 1);
    gpiote_init(pin0, 0);
    gpiote_init(pin1, 1);
    ppi_init(0, 1);
}

#define FIRST_PHASE_START 40
#define SECOND_PHASE_START (FIRST_PHASE_START+CYCLES_PER_TICK)

int8_t *sound_buffer_ptr;
volatile int32_t sound_buffer_read_index;
int32_t sound_buffer_write_index;

#define SOUND_BUFFER_MASK (SOUND_BUFFER_SIZE-1)

static mp_obj_t buffer_iter = NULL;
static bool callback_needed_for_data = false;

static void sound_data_fetcher(void) {
    mp_buffer_info_t buf_info;
    if (buffer_iter == NULL)
        return;
    mp_obj_t buffer_obj = mp_iternext(buffer_iter);
    if (buffer_obj == MP_OBJ_STOP_ITERATION) {
        sound_stop();
        buffer_iter = NULL;
        return;
    }
    if (!mp_get_buffer(buffer_obj, &buf_info, MP_BUFFER_READ) || buf_info.len != SOUND_CHUNK_SIZE) {
        /* TO DO -- report error */
        sound_stop();
        buffer_iter = NULL;
        return;
    }
    const int32_t *data = ((const int32_t*)buf_info.buf);
    int32_t *half_buffer = (int32_t*)(sound_buffer_ptr + sound_buffer_write_index);
    half_buffer[0] = data[0];
    half_buffer[1] = data[1];
    half_buffer[2] = data[2];
    half_buffer[3] = data[3];
    half_buffer[4] = data[4];
    half_buffer[5] = data[5];
    half_buffer[6] = data[6];
    half_buffer[7] = data[7];
    sound_buffer_write_index = (sound_buffer_write_index+SOUND_CHUNK_SIZE)&SOUND_BUFFER_MASK;
    return;
}

static inline void set_gpiote_output_pulses(int32_t val1, int32_t val2) {
    NRF_TIMER_Type *timer = TheTimer;
    timer->TASKS_CLEAR = 1;
    //Start without output zero; pins 00
    if (val1 != 0) {
        if (val1 < 0) {
            timer->CC[0] = FIRST_PHASE_START;
            // -ve 10
            timer->CC[2] = FIRST_PHASE_START-val1;
            // zero 11
        } else {
            timer->CC[2] = FIRST_PHASE_START;
            // +ve 01
            timer->CC[0] = FIRST_PHASE_START+val1;
            // zero 11
        }
        // Zero; pins 11.
        if (val2 != 0) {
            if (val2 < 0) {
                timer->CC[3] = SECOND_PHASE_START;
                // -ve 10
                timer->CC[1] = SECOND_PHASE_START-val2;
                // zero 00
            } else {
                timer->CC[1] = SECOND_PHASE_START;
                // +ve 01
                timer->CC[3] = SECOND_PHASE_START+val2;
                // zero 00
            }
        } else {
            // Pins are 11 and we want to restore them to default state of 00
            timer->CC[1] = SECOND_PHASE_START;
            timer->CC[3] = SECOND_PHASE_START;
            // zero 00
        }
    } else {
        // Zero; pins 00
        if (val2 != 0) {
            if (val2 < 0) {
                timer->CC[2] = -1;
                timer->CC[0] = SECOND_PHASE_START;
                // -ve 10
                timer->CC[1] = SECOND_PHASE_START-val2;
                // zero 00
                timer->CC[3] = -1;
            } else {
                timer->CC[0] = -1;
                timer->CC[2] = SECOND_PHASE_START;
                // +ve 01
                timer->CC[3] = SECOND_PHASE_START+val2;
                // zero 00
                timer->CC[1] = -1;
            }
        } else {
            //All zero, state will remain 00 throughout.
            timer->CC[0] = -1;
            timer->CC[2] = -1;
            timer->CC[1] = -1;
            timer->CC[3] = -1;
        }
    }
}

static int32_t sound_ticker(void) {
    int32_t val1 = previous_value + delta;
    int32_t next_value = val1 + delta;
    previous_value = next_value;
    set_gpiote_output_pulses(val1>>1, next_value>>1);
    if (sample) {
        int32_t buffer_index = (int32_t)sound_buffer_read_index;
        buffer_index = (buffer_index+1)&SOUND_BUFFER_MASK;
        int32_t sample = sound_buffer_ptr[buffer_index]<<2;
        sound_buffer_read_index = buffer_index;
        delta = (sample-next_value)>>2;
        if ((buffer_index&(SOUND_CHUNK_SIZE-1)) == 0) {
            sound_buffer_write_index = (buffer_index+SOUND_CHUNK_SIZE)&SOUND_BUFFER_MASK;
            set_low_priority_callback(sound_data_fetcher, SOUND_CALLBACK_ID);
        }
    }
    sample = !sample;
    /* Need to be triggered every 2 ticks. */
    return 2;
}

void sound_play_source(mp_obj_t iter, bool wait) {
    buffer_iter = iter;
    callback_needed_for_data = true;
    sound_start();
    if (!wait) {
        return;
    }
    while(running) {
        if (MP_STATE_VM(mp_pending_exception) != MP_OBJ_NULL) {
            buffer_iter = NULL;
            sound_stop();
            return;
        }
        __WFI();
    }
}


void clear_buffer(void) {
    memset(sound_buffer_ptr, 0, SOUND_BUFFER_SIZE);
}

void reset_buffer(void) {
    clear_buffer();
    sound_buffer_read_index = sound_buffer_write_index = 0;
}


/* At 8kHz this is a 250Hz triangle wave */
static const int8_t test_sample1[] = {
    0, 15, 30, 45, 60, 75, 90, 105,
    120, 105, 90, 75, 60, 45, 30, 15,
    0, -15, -30, -45, -60, -75, -90, -105,
    -120, -105, -90, -75, -60, -45, -30, -15
};

/* At 8kHz this is a 500Hz square wave */
static const int8_t test_sample2[] = {
    120, 120, 120, 120, 120, 120, 120, 120,
    -120, -120, -120, -120, -120, -120, -120, -120,
    120, 120, 120, 120, 120, 120, 120, 120,
    -120, -120, -120, -120, -120, -120, -120, -120,
};

static const int8_t sample_microbit[] = {
0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, -1,
-1, -1, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, -1, 0, -1,
0, -1, 0, 0, 0, 0, 0, -1, -1, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, -1, -1, 0, -1, 0, 0, 0, 0, -1, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, -1, -1, -1, -1, -1, -1, -1, -1,
0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1,
1, 1, 1, 0, 0, 0, 0, 0, -1, -1, -1, 0, 0, 0, 0, 0,
1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
1, 1, 1, 1, 1, 0, 0, 0, 0, -1, -1, -1, -1, -1, -1, -1,
-1, 0, -1, -1, -1, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1,
0, 1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, -1, -1,
-1, 0, -1, -1, -1, -1, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, -1, 0, -1,
0, -1, -1, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, 0,
0, 0, -1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, -1, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, -1, -1, -1, -1, -1, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1,
1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0, 0, 1, 0,
1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, -1,
-1, 0, -1, -1, 0, -1, 0, 0, -1, -1, 0, -1, 0, 0, 0, 0,
0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, -1, -1, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0,
0, 0, 0, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0, 0, 0,
0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1,
0, -1, -1, -2, -2, -3, -3, -4, -4, -5, -5, -4, -4, -4, -3, -2,
-1, -1, 0, 1, 1, 2, 3, 4, 4, 5, 6, 7, 8, 9, 9, 9,
8, 6, 5, 3, 1, 0, -2, -4, -6, -8, -10, -12, -14, -16, -17, -17,
-16, -15, -13, -7, -4, 0, 5, 8, 12, 13, 14, 15, 13, 13, 12, 12,
12, 11, 11, 11, 10, 9, 7, 5, 2, -1, -4, -6, -9, -11, -13, -16,
-19, -23, -25, -26, -27, -24, -18, -14, -6, 1, 8, 15, 18, 21, 21, 20,
19, 17, 16, 14, 13, 13, 11, 10, 9, 8, 6, 5, 3, 1, -1, -3,
-5, -8, -10, -13, -16, -20, -24, -28, -32, -31, -30, -25, -17, -9, 2, 11,
19, 25, 27, 28, 27, 24, 21, 18, 16, 14, 12, 11, 9, 7, 5, 4,
2, 0, -1, -2, -3, -4, -5, -8, -11, -15, -20, -25, -29, -34, -35, -32,
-28, -20, -11, 0, 12, 20, 27, 31, 31, 30, 27, 23, 19, 15, 13, 10,
8, 5, 4, 4, 2, 2, 2, 1, 1, 1, 0, -2, -4, -8, -12, -17,
-23, -29, -34, -40, -39, -34, -30, -20, -8, 4, 18, 26, 33, 36, 35, 32,
28, 22, 17, 13, 9, 5, 0, -1, 0, -1, 1, 4, 5, 9, 9, 8,
6, 2, -3, -8, -15, -21, -27, -33, -37, -43, -43, -36, -33, -23, -9, 3,
18, 28, 35, 40, 38, 35, 30, 22, 16, 10, 5, 1, -2, -1, -1, 0,
2, 4, 8, 10, 10, 9, 7, 4, -1, -7, -14, -19, -27, -33, -38, -45,
-46, -39, -34, -26, -12, 2, 17, 29, 36, 41, 40, 36, 30, 23, 16, 9,
5, 1, -3, -3, -2, 0, 3, 5, 9, 12, 12, 12, 9, 5, 1, -6,
-13, -20, -28, -35, -40, -49, -50, -42, -38, -29, -14, 1, 18, 31, 38, 43,
43, 39, 33, 25, 17, 10, 5, 1, -5, -8, -7, -3, -1, 3, 9, 15,
18, 20, 19, 16, 8, -1, -9, -18, -27, -36, -43, -52, -57, -47, -43, -38,
-21, -4, 15, 30, 39, 46, 48, 43, 38, 29, 18, 9, 3, -2, -8, -11,
-11, -6, 0, 2, 10, 19, 21, 24, 24, 19, 13, 1, -8, -18, -29, -38,
-49, -64, -83, -70, -31, -6, 6, 17, 35, 36, 13, 11, 31, 35, 28, 35,
33, 6, -11, 1, 6, -9, -5, 18, 15, 4, 14, 21, 17, 23, 32, 18,
-12, -22, -28, -47, -59, -58, -60, -91, -61, 29, 25, -18, -9, -1, -7, 24,
72, 52, 2, 15, 34, 5, 9, 45, 24, -22, -15, 1, -11, 10, 53, 38,
3, 17, 27, 10, 8, 5, -19, -32, -30, -43, -62, -62, -63, -86, -38, 46,
18, -23, -5, -1, 3, 53, 69, 17, 1, 32, 22, 5, 33, 26, -16, -9,
9, -14, -2, 46, 37, 11, 18, 17, 14, 26, 14, -25, -34, -22, -42, -59,
-57, -55, -81, -60, 37, 21, -31, 5, 2, -10, 55, 72, 9, 2, 37, 19,
9, 39, 19, -16, -1, 8, -13, -3, 33, 28, 21, 33, 16, 12, 26, 9,
-12, -21, -26, -36, -44, -58, -67, -68, -86, -9, 57, -11, -20, 5, -15, 34,
81, 25, -8, 26, 26, 13, 34, 22, -16, 1, 14, -10, 11, 38, 11, 12,
29, 16, 27, 26, -7, -12, -14, -25, -33, -49, -58, -59, -50, -72, -47, 38,
16, -18, 4, -13, 15, 73, 37, -4, 21, 25, 18, 36, 19, -12, 6, 18,
-2, 11, 27, 11, 18, 21, 5, 24, 20, -8, -12, -26, -39, -43, -49, -56,
-47, -72, -44, 40, -10, -26, 18, -22, 4, 73, 26, -7, 25, 20, 28, 43,
4, -1, 27, 8, 0, 15, 16, 25, 27, 8, 4, 18, 12, 4, -16, -37,
-33, -45, -52, -57, -60, -59, -7, 29, -31, -20, 8, -10, 32, 45, 1, 18,
26, 14, 39, 23, 1, 24, 12, -4, 24, 3, 3, 52, 15, 7, 29, -2,
15, 11, -27, -18, -32, -52, -39, -56, -44, -59, -64, 38, 3, -27, 25, -34,
5, 74, 8, 18, 29, -11, 45, 36, -10, 27, 6, -4, 36, -1, 2, 37,
12, 19, 20, 3, 14, 1, -10, -25, -31, -32, -38, -42, -69, -38, -45, -22,
36, -28, -5, 17, -22, 45, 41, 2, 32, 5, 15, 43, 1, 10, 13, -6,
23, 10, -4, 29, 20, 20, 28, -5, 11, 11, -13, -8, -39, -26, -25, -58,
-45, -53, -64, -10, 21, -16, 2, -6, -14, 40, 27, 29, 29, -10, 27, 30,
6, 25, -3, -1, 20, 2, 12, 16, 14, 23, 19, 16, 16, 4, -2, -8,
-25, -29, -39, -33, -32, -57, -42, -59, -9, 37, -15, 11, -14, -13, 53, 29,
31, 14, -9, 33, 21, 18, 15, -15, 10, 5, 5, 25, 9, 23, 19, 8,
21, 8, 1, -1, -16, -21, -34, -43, -47, -48, -26, -55, -34, 11, -11, 23,
-4, -14, 25, 15, 50, 26, -3, 22, 7, 26, 21, -2, 6, -5, 0, 10,
23, 22, 18, 15, 5, 20, 8, 1, -6, -30, -23, -41, -35, -44, -43, -33,
-67, -1, -2, 6, 26, -28, 12, 10, 34, 52, 6, 17, 5, 14, 23, 11,
12, -5, -1, -7, 16, 30, 20, 24, 2, 12, 18, 7, 5, -15, -24, -27,
-41, -43, -47, -41, -50, -28, 2, -5, 18, -6, -3, 7, 19, 46, 24, 20,
10, 7, 17, 15, 14, 9, -4, -4, -9, 12, 34, 25, 26, 5, 5, 13,
8, 2, -20, -21, -34, -37, -42, -52, -38, -50, -17, -3, 3, 18, -5, 2,
1, 25, 35, 32, 23, 10, 7, 9, 12, 11, 10, 0, 0, -7, 11, 22,
25, 28, 14, 11, 7, 7, -4, -17, -21, -35, -29, -40, -44, -38, -68, -29,
-13, 10, 34, 12, 6, -5, 5, 18, 33, 31, 30, 16, 3, -3, -2, 4,
8, 6, 1, 10, 13, 21, 24, 20, 14, 13, 4, -4, -16, -25, -26, -23,
-32, -36, -36, -65, -46, -28, -5, 29, 27, 23, 11, 3, 3, 11, 18, 29,
29, 22, 12, -1, -7, -8, -4, 3, 13, 21, 24, 24, 18, 14, 14, 9,
3, -8, -17, -24, -32, -35, -38, -39, -48, -46, -33, -16, 7, 20, 26, 25,
21, 14, 8, 7, 9, 16, 20, 22, 19, 9, 1, -8, -11, -7, 0, 15,
22, 26, 26, 19, 14, 4, -6, -14, -20, -24, -26, -26, -26, -25, -25, -31,
-30, -24, -16, -3, 6, 17, 26, 27, 27, 21, 15, 11, 4, 3, 1, 0,
1, 1, 1, 0, 2, 1, 5, 5, 6, 10, 9, 10, 7, 3, 0, -5,
-9, -13, -14, -14, -15, -14, -11, -9, -6, -5, -4, -2, -2, 0, 1, 5,
7, 8, 10, 10, 8, 5, 3, 0, -1, -1, -1, 1, 0, 3, 4, 4,
6, 4, 4, 3, 2, 2, 0, -1, -3, -5, -7, -8, -8, -8, -7, -6,
-5, -2, -3, -2, 0, -1, 0, 0, -1, 0, -1, -2, -1, -1, 1, 2,
1, 3, 3, 2, 4, 4, 5, 6, 6, 6, 6, 6, 5, 3, 2, 1,
-1, -1, -3, -4, -5, -5, -3, -4, -3, -2, -1, 1, 0, 1, 1, 0,
-1, -2, -3, -4, -4, -4, -3, -3, -2, -1, 0, 2, 2, 3, 4, 4,
5, 5, 4, 3, 3, 2, 1, 0, -1, -2, -2, -3, -3, -3, -3, -2,
-1, 0, 0, 1, 1, 1, 1, 0, -1, -1, -2, -2, -3, -3, -3, -3,
-2, -1, 0, 1, 2, 3, 4, 4, 4, 4, 3, 2, 1, -1, 0, -1,
-2, -2, -2, -2, -2, -1, -1, 0, 0, 0, 0, 0, 0, 0, 0, -1,
-2, -2, -2, -2, -2, -1, -1, 0, 0, 1, 1, 1, 2, 2, 2, 2,
1, 1, 1, 0, 0, -1, -1, -1, -2, -1, -1, -1, 0, 0, 1, 1,
1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
1, 2, 2, 2, 2, 2, 1, 0, 0, -1, -1, -1, -2, -2, -2, -2,
-1, -1, 0, 0, 1, 1, 2, 2, 2, 1, 1, 0, -1, -1, -1, -1,
-1, 0, -1, -1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0,
0, -1, -1, -1, -1, -1, -1, -1, 0, 0, 1, 0, 0, 1, 1, 1,
1, 1, 0, 0, 0, 0, 0, 0, -1, -1, -1, 0, 0, 0, 1, 1,
1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, -1, -1, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 1, 12, 10, -5, 1, 5, -4, -1, 4, -2, -4, 4, 4, -3, 0,
3, -4, -9, -14, -11, 8, 4, -10, 9, 31, 9, -12, 3, 0, -15, -2,
8, -8, -6, 13, 8, -6, 0, 7, -2, -6, 0, -1, -3, 4, 5, 1,
4, 7, 13, 11, -3, -4, -2, -6, -6, -2, -1, 0, 4, 1, -5, -3,
1, -4, -9, -4, -2, -5, -4, 0, -4, -10, -1, 1, -7, -2, 4, -1,
-1, 3, 5, 4, 7, 10, 4, 1, 4, -2, -7, -1, -2, -5, 1, 2,
-1, 2, 2, 0, 0, 2, -2, -7, -2, -1, -5, -2, 4, 3, 0, 0,
0, -3, -1, 1, -3, 1, 5, 1, -1, 2, 4, 3, 2, 2, -3, -6,
-2, -2, -5, 0, 1, -4, -1, 3, 0, -1, 2, 2, 0, 5, 4, 3,
1, 1, 3, 0, -3, -1, 0, -2, -3, -1, 0, 0, -1, 2, 2, -1,
0, 1, -1, 1, 2, -2, 1, 2, -1, -1, -2, 0, 0, -1, 3, 0,
0, 2, 1, 0, 3, 1, 0, 4, 1, 1, 0, -2, -2, -2, -2, -2,
-1, 1, 0, -2, 0, 1, -3, 0, 2, -2, 0, 1, 1, 1, -1, 1,
1, -1, 1, 0, 1, 0, -2, 2, 1, 0, -1, -1, 1, -2, 0, 2,
-2, -2, 1, -1, -5, 0, 1, -4, -1, 2, 0, -2, 1, 2, -3, 0,
1, -2, -1, 2, 2, -1, -1, 2, 1, -3, 1, 1, -4, -1, 2, 0,
-1, 3, 3, 0, 2, 0, -1, 0, -2, -1, 0, 0, 1, 3, 2, 1,
2, 0, 0, 1, 2, 1, -1, 1, 1, -2, -2, 1, -1, -2, -1, 0,
-3, -5, -3, -3, -5, -2, 0, -1, 1, 2, 2, 1, 0, 1, 0, -1,
2, 3, 2, 4, 7, 5, 6, 7, 5, 6, 6, 4, 3, 1, -1, -4,
-6, -7, -11, -13, -14, -15, -18, -19, -20, -25, -16, -2, 4, 12, 21, 23,
18, 14, 8, -1, -7, -3, 4, 11, 24, 34, 32, 26, 21, 12, 1, -3,
-5, -9, -6, -2, -7, -16, -21, -33, -45, -55, -56, -29, -10, 6, 29, 37,
31, 22, 13, -7, -19, -14, -2, 5, 18, 35, 34, 26, 24, 20, 7, 4,
10, 11, 14, 21, 20, 7, -6, -16, -32, -48, -51, -56, -57, -60, -35, -1,
1, 22, 37, 27, 14, 13, 4, -12, -5, 10, 16, 20, 35, 32, 17, 9,
2, -1, 7, 19, 23, 27, 30, 28, 17, 1, -14, -31, -36, -42, -46, -49,
-46, -52, -60, -18, -2, 1, 35, 39, 21, 18, 21, -4, -11, 7, 15, 12,
30, 39, 16, 9, 6, -10, -8, 16, 26, 26, 33, 32, 18, 9, -1, -22,
-35, -31, -39, -45, -46, -47, -58, -68, -14, -4, 4, 48, 39, 16, 21, 17,
-15, -6, 16, 17, 24, 42, 29, 6, 4, -11, -28, -6, 27, 25, 37, 43,
24, 18, 17, -5, -22, -26, -30, -38, -42, -46, -54, -53, -77, -36, 6, 2,
45, 51, 19, 18, 21, -10, -7, 21, 23, 28, 41, 27, 0, -3, -15, -29,
-7, 25, 29, 40, 42, 20, 15, 18, -1, -14, -18, -29, -29, -40, -44, -53,
-51, -64, -68, 0, 8, 20, 62, 30, 9, 25, 4, -16, 18, 28, 23, 37,
32, -1, -8, -10, -26, -14, 15, 29, 34, 40, 24, 14, 21, 9, -4, -6,
-22, -27, -25, -45, -45, -48, -49, -60, -61, 5, 12, 24, 60, 28, 12, 23,
0, -12, 19, 21, 22, 34, 20, -6, -8, -14, -27, -8, 21, 29, 31, 37,
19, 18, 23, 6, -2, -8, -24, -25, -32, -48, -47, -51, -50, -69, -41, 15,
5, 41, 55, 12, 16, 19, -13, 0, 27, 18, 29, 35, 7, -11, -8, -22,
-23, 13, 24, 26, 42, 25, 16, 28, 12, 2, 2, -18, -24, -23, -45, -48,
-49, -53, -53, -67, -15, 14, 12, 54, 36, 7, 22, 4, -13, 17, 24, 22,
37, 24, -3, -7, -14, -28, -3, 20, 21, 39, 35, 16, 26, 19, 2, 5,
-7, -22, -18, -31, -48, -45, -51, -50, -58, -52, 5, 10, 27, 56, 19, 11,
20, -8, -4, 24, 20, 28, 37, 13, -4, -7, -23, -21, 9, 18, 28, 43,
25, 19, 28, 9, 2, 5, -15, -20, -19, -39, -45, -45, -55, -48, -61, -47,
8, 8, 33, 53, 17, 17, 17, -12, 1, 21, 16, 32, 36, 9, -2, -6,
-26, -18, 10, 13, 31, 42, 23, 25, 26, 4, 5, 0, -20, -15, -23, -41,
-41, -46, -54, -46, -62, -43, 8, 7, 37, 54, 20, 23, 16, -13, 1, 16,
13, 34, 36, 11, 6, -6, -26, -13, 3, 7, 33, 37, 26, 33, 21, 4,
5, -9, -19, -17, -29, -35, -39, -47, -49, -46, -62, -43, 5, 5, 38, 56,
25, 27, 18, -13, -2, 8, 8, 33, 35, 17, 14, -4, -25, -14, -9, 1,
32, 35, 33, 41, 23, 7, 5, -13, -22, -19, -30, -32, -35, -42, -46, -47,
-59, -53, -9, 3, 29, 58, 37, 33, 28, -5, -9, -1, -3, 18, 33, 24,
20, 10, -15, -18, -12, -8, 17, 31, 33, 41, 33, 15, 8, -10, -26, -25,
-31, -34, -31, -33, -39, -38, -48, -56, -22, -4, 12, 47, 49, 40, 42, 22,
-4, -7, -9, -7, 11, 21, 19, 22, 15, -3, -6, -4, -4, 7, 21, 25,
30, 28, 13, 1, -12, -25, -31, -35, -37, -33, -28, -27, -26, -34, -34, -16,
-7, 4, 26, 35, 37, 43, 33, 15, 5, -4, -11, -11, -7, 0, 6, 8,
10, 11, 7, 5, 7, 6, 9, 12, 10, 8, 4, -2, -8, -14, -21, -23,
-24, -22, -19, -19, -17, -18, -13, -4, -3, 0, 5, 10, 13, 16, 17, 14,
11, 10, 7, 3, 3, 2, 0, 1, 1, 0, 3, 5, 6, 7, 10, 11,
8, 7, 3, -2, -5, -10, -14, -15, -17, -18, -17, -18, -17, -17, -15, -12,
-9, -5, 1, 7, 11, 14, 15, 14, 13, 11, 8, 7, 6, 4, 4, 3,
2, 3, 3, 3, 5, 7, 7, 8, 9, 6, 4, 1, -4, -7, -10, -14,
-16, -17, -18, -18, -18, -18, -15, -10, -7, -2, 4, 9, 12, 14, 15, 14,
11, 11, 9, 6, 6, 5, 3, 2, 2, 1, 1, 3, 3, 5, 7, 6,
6, 5, 2, 0, -2, -6, -9, -11, -14, -16, -17, -18, -18, -16, -14, -10,
-7, -3, 2, 6, 10, 12, 13, 13, 13, 11, 9, 7, 5, 3, 2, 1,
1, 1, 2, 3, 4, 5, 6, 7, 6, 5, 3, 0, -3, -6, -9, -12,
-14, -15, -15, -15, -14, -12, -11, -8, -6, -4, 0, 3, 7, 10, 12, 13,
13, 12, 10, 8, 6, 5, 4, 3, 3, 3, 3, 2, 3, 4, 4, 5,
4, 4, 2, 0, -2, -5, -7, -10, -11, -12, -12, -11, -11, -10, -9, -8,
-6, -5, -2, 1, 5, 9, 11, 12, 12, 11, 9, 8, 6, 5, 4, 3,
2, 2, 2, 2, 3, 3, 4, 4, 4, 3, 3, 1, -1, -3, -5, -7,
-8, -9, -10, -10, -10, -10, -9, -9, -7, -5, -3, -1, 2, 4, 7, 9,
10, 10, 9, 8, 7, 6, 5, 4, 3, 3, 3, 2, 2, 3, 4, 3,
3, 2, 1, -1, -2, -3, -5, -6, -7, -9, -10, -10, -11, -10, -9, -9,
-7, -6, -4, -2, 0, 3, 5, 7, 9, 10, 10, 9, 8, 6, 5, 4,
3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 0, -1, -2, -4,
-6, -7, -8, -9, -8, -8, -8, -7, -6, -5, -4, -3, -1, 1, 3, 5,
7, 9, 8, 8, 8, 6, 6, 4, 4, 3, 3, 3, 2, 1, 1, 2,
1, 2, 2, 1, 0, 0, -2, -3, -4, -6, -6, -8, -3, -2, -4, 7,
-3, -6, 1, -13, -8, 1, -6, 5, 12, 6, 15, 11, 4, 8, 0, -1,
5, 1, 7, 13, 11, 17, 15, 9, 10, 2, -1, -2, -7, -6, -9, -11,
-13, -18, -22, -28, -34, -36, -22, -16, -2, 14, 14, 25, 20, 12, 10, -6,
-4, -4, -6, 6, 8, 14, 19, 13, 14, 9, 11, 15, 13, 19, 18, 18,
16, 6, -1, -15, -23, -31, -37, -40, -43, -41, -52, -26, -21, -5, 26, 15,
40, 29, 21, 20, -9, -3, -12, -8, 8, 8, 26, 25, 21, 21, 5, 5,
4, 8, 19, 23, 29, 26, 18, 5, -14, -30, -46, -53, -56, -57, -44, -57,
-34, -17, -12, 30, 18, 39, 37, 24, 28, -1, 4, -8, -2, 5, 9, 24,
19, 24, 10, 10, 3, 0, 10, 11, 30, 32, 37, 28, 14, -2, -24, -37,
-55, -55, -60, -51, -46, -54, -23, -22, 6, 26, 26, 48, 32, 38, 19, 9,
0, -5, 2, 1, 18, 14, 24, 12, 6, 0, -8, 5, 5, 24, 31, 40,
38, 28, 12, -10, -29, -46, -54, -56, -54, -49, -40, -53, -27, -23, -3, 23,
23, 49, 37, 43, 25, 14, 1, -6, -2, -2, 12, 12, 23, 12, 11, -5,
-5, -3, 3, 21, 27, 43, 36, 36, 15, -4, -24, -43, -46, -56, -44, -47,
-34, -39, -41, -20, -19, 12, 22, 39, 45, 43, 36, 18, 6, -10, -6, -10,
3, 7, 16, 16, 8, 1, -12, -9, -5, 12, 25, 38, 41, 38, 24, 4,
-17, -38, -45, -55, -46, -46, -36, -31, -44, -24, -24, -2, 18, 29, 43, 40,
39, 20, 11, -9, -8, -11, -4, 5, 9, 16, 5, 3, -12, -11, -7, 8,
25, 38, 45, 40, 32, 10, -8, -29, -41, -45, -47, -38, -38, -30, -38, -45,
-26, -23, 9, 23, 38, 47, 41, 33, 12, 0, -15, -10, -9, 4, 10, 16,
12, 1, -7, -16, -11, 1, 22, 37, 50, 47, 39, 20, 0, -19, -35, -39,
-41, -35, -28, -30, -26, -49, -40, -28, -15, 21, 30, 52, 47, 42, 22, 6,
-11, -14, -8, -1, 15, 15, 21, 5, -2, -16, -16, -6, 15, 37, 49, 54,
42, 29, 8, -11, -25, -35, -35, -35, -28, -29, -32, -35, -56, -35, -27, 1,
30, 40, 53, 40, 31, 6, -5, -18, -9, -1, 12, 19, 18, 13, -6, -12,
-24, -10, 5, 32, 49, 54, 51, 32, 17, -5, -18, -30, -32, -31, -32, -27,
-37, -36, -54, -55, -31, -18, 24, 36, 50, 45, 31, 14, -5, -12, -14, 2,
8, 22, 16, 11, -7, -19, -24, -20, 0, 23, 45, 50, 50, 32, 18, 0,
-15, -24, -32, -28, -33, -30, -38, -42, -50, -66, -37, -26, 11, 35, 43, 48,
29, 18, -5, -8, -14, 2, 10, 19, 18, 7, -4, -22, -25, -23, -3, 19,
43, 47, 48, 34, 19, 6, -11, -17, -26, -24, -31, -29, -36, -42, -45, -65,
-37, -27, 7, 35, 39, 49, 29, 22, -2, -4, -9, 5, 13, 19, 20, 6,
-1, -23, -22, -23, 2, 22, 39, 46, 39, 31, 17, 7, -10, -16, -24, -23,
-30, -30, -40, -41, -49, -63, -32, -27, 14, 32, 39, 45, 26, 21, -2, -2,
-7, 9, 15, 23, 19, 7, -3, -22, -22, -18, 7, 20, 39, 39, 36, 27,
15, 3, -13, -18, -26, -24, -32, -33, -41, -42, -62, -50, -33, -18, 23, 24,
42, 30, 24, 10, -4, -5, -3, 13, 15, 27, 15, 9, -8, -22, -20, -11,
9, 23, 35, 34, 35, 24, 13, -2, -16, -20, -24, -26, -27, -34, -33, -47,
-53, -33, -30, 6, 20, 30, 39, 27, 24, 4, 0, -6, 5, 12, 22, 26,
18, 12, -8, -8, -14, -2, 10, 19, 30, 31, 33, 20, 9, -7, -17, -23,
-30, -29, -33, -31, -35, -47, -32, -28, -11, 13, 17, 34, 31, 29, 19, 6,
2, -2, 6, 11, 21, 22, 19, 13, 6, -1, -3, 1, 3, 14, 20, 25,
24, 14, 4, -9, -18, -29, -33, -34, -34, -29, -37, -30, -20, -18, 4, 6,
17, 26, 23, 27, 15, 13, 9, 4, 7, 6, 11, 12, 11, 10, 6, 3,
2, 1, 3, 6, 10, 12, 11, 8, 3, -2, -9, -14, -17, -20, -17, -18,
-17, -17, -14, -10, -9, -1, 2, 10, 16, 18, 23, 19, 19, 17, 14, 13,
10, 7, 4, 2, 1, 1, 1, 3, 4, 5, 8, 6, 6, 4, 2, 0,
-4, -6, -9, -11, -11, -12, -13, -13, -12, -11, -10, -8, -5, -1, 2, 6,
9, 10, 11, 11, 10, 8, 5, 1, -1, -3, -5, -4, -5, -3, -2, -1,
0, -1, 0, -1, -1, -2, -2, -3, -4, -5, -6, -8, -8, -9, -9, -8,
-7, -5, -3, -2, 0, 2, 4, 5, 7, 8, 8, 8, 6, 3, 2, -1,
-1, -3, -2, -1, -1, 1, 1, 2, 2, 2, 2, 2, 3, 2, 2, 1,
0, 0, -1, -1, -2, -2, -2, -2, -1, -1, 1, 1, 3, 5, 5, 7,
7, 7, 4, 2, 0, -2, -3, -5, -4, -4, -2, -2, -1, 0, 0, 1,
1, 2, 3, 3, 3, 2, 2, 1, 0, -1, -2, -2, -2, -2, -1, -1,
-1, 0, 1, 1, 2, 3, 3, 3, 2, 1, -1, -2, -3, -3, -3, -3,
-2, -1, -1, -1, -1, 0, 1, 2, 3, 4, 4, 4, 3, 2, 1, 0,
-1, -2, -2, -2, -2, -2, -2, -2, -2, -2, -1, -1, 0, 0, -1, -1,
-2, -3, -4, -4, -3, -4, -3, -3, -3, -3, -3, -2, -2, -1, 0, 1,
1, 1, 0, -1, -2, -2, -3, -3, -2, -2, -2, -3, -2, -2, -2, -1,
0, 1, 1, 2, 1, 1, 0, -1, -1, -1, -1, -1, -1, 0, 0, 0,
0, 1, 1, 2, 2, 3, 2, 2, 2, 2, 1, 0, 0, -1, 0, -1,
0, 0, 0, 0, 0, 1, 2, 2, 3, 3, 3, 2, 2, 1, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 1,
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 2, 2, 2,
2, 2, 2, 2, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0,
1, 1, 1, 3, 6, 2, 2, 2, 0, 2, 3, 0, 0, 0, 0, 0,
0, 1, 0, 2, 3, 1, 1, 0, 0, 0, -2, 0, -1, -1, 0, -1,
-1, -1, -1, -1, -2, -1, 0, -1, 0, 0, 0, 0, 0, -1, -1, 0,
-1, 0, 0, 0, 0, -1, 0, -1, -1, 0, 0, 0, 0, 2, 3, 1,
0, -2, -1, -1, -1, -1, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, -1, -1, 0, -1, -1,
-2, -1, 1, 1, 1, 0, -1, -1, -1, -1, -1, -2, -1, -1, -1, -1,
-1, -1, -1, -1, 0, 0, -1, 0, 0, -1, 0, 0, 0, 0, -1, 0,
-1, -1, 0, -1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 1,
0, 0, 0, 0, 0, -1, 0, 0, 0, 0, 0, -1, 0, -1, 0, -1,
-1, 0, -1, 0, 0, -1, 0, -1, 0, 0, 0, 0, -1, 0, 0, 0,
1, 0, 0, 0, 0, 0, 0, -1, 0, -1, -1, 0, -1, 0, -1, 0,
1, -1, 0, -1, -1, 0, -1, 0, 0, -1, 0, 0, 0, 1, 0, 0,
0, 0, 0, -1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, -1,
};

const MP_DEFINE_STR_OBJ(microbit_sound_microbit_sample_obj, sample_microbit);

static const int8_t silence[] = {
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
};

const MP_DEFINE_STR_OBJ(microbit_sound_silence_obj, silence);


